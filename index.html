<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=800, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>December Velocity Dashboard</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
      crossorigin
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        color-scheme: dark;
      }
      * {
        box-sizing: border-box;
        font-family: "Space Mono", monospace;
        transition: none !important;
        animation: none !important;
      }
      body {
        margin: 0;
        background: #000;
        color: #f7f7f2;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .dashboard {
        width: 800px;
        height: 480px;
        background: #020202;
        border: 2px solid #1f1f1f;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px 16px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        text-transform: uppercase;
        letter-spacing: 0.09em;
      }
      header h1 {
        font-size: 20px;
        margin: 0;
      }
      header span {
        font-size: 12px;
        color: #9b9b9b;
      }
      .graph-grid {
        display: grid;
        grid-template-rows: repeat(3, minmax(0, 1fr));
        gap: 6px;
        flex: 1;
      }
      .card {
        border: 1px solid #2b2b2b;
        background: #080808;
        padding: 6px 10px 8px;
        display: grid;
        grid-template-rows: auto 1fr auto auto;
        gap: 4px;
      }
      .card h2 {
        margin: 0;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #dcdcdc;
      }
      .status-line {
        font-size: 12px;
        color: #a1a1a1;
        margin: 0;
      }
      .status-line strong {
        color: #e0e0e0;
      }
      canvas {
        width: 100% !important;
        height: 105px !important;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .controls label {
        display: flex;
        flex-direction: column;
        gap: 2px;
        color: #afafaf;
      }
      .controls input {
        background: #050505;
        border: 1px solid #333;
        color: #f7f7f2;
        padding: 2px 4px;
        width: 70px;
      }
      .controls button {
        border: 1px solid #5eff00;
        background: #031901;
        color: #bef67a;
        padding: 4px 10px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .controls button:focus-visible,
      .controls input:focus-visible {
        outline: 1px solid #5eff00;
      }
      .formula {
        font-size: 11px;
        color: #6c6c6c;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      footer {
        font-size: 11px;
        color: #7c7c7c;
        text-transform: uppercase;
        display: flex;
        justify-content: space-between;
        letter-spacing: 0.05em;
      }
      @media (max-width: 799px) {
        body {
          align-items: flex-start;
        }
        .dashboard {
          width: 100%;
          height: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <header>
        <h1>December Velocity</h1>
        <span>Day 1 logged · targets lock to Dec 30</span>
      </header>
      <div class="graph-grid">
        <section class="card" id="healthCard">
          <h2>Health velocity · 20 workouts</h2>
          <p class="status-line">
            <strong>Signal</strong>:
            <span id="healthStatus">Calculating…</span>
          </p>
          <canvas id="healthChart" aria-label="Health velocity chart"></canvas>
          <div class="controls">
            <label for="healthDay">Day
              <input id="healthDay" type="number" min="1" max="30" value="1" />
            </label>
            <label for="healthValue">Workouts
              <input id="healthValue" type="number" step="0.1" value="1" />
            </label>
            <button id="healthLog">Log health</button>
          </div>
          <div class="formula">R' = R + 32 × (S − E)</div>
        </section>
        <section class="card" id="codingCard">
          <h2>Coding velocity · 300 problems</h2>
          <p class="status-line">
            <strong>Signal</strong>:
            <span id="codingStatus">Calculating…</span>
          </p>
          <canvas id="codingChart" aria-label="Coding velocity chart"></canvas>
          <div class="controls">
            <label for="codingDay">Day
              <input id="codingDay" type="number" min="1" max="30" value="1" />
            </label>
            <label for="codingValue">Problems
              <input id="codingValue" type="number" step="1" value="5" />
            </label>
            <button id="codingLog">Log coding</button>
          </div>
          <div class="formula">R' = R + 32 × (S − E)</div>
        </section>
        <section class="card" id="aiCard">
          <h2>AI learning velocity · 30 videos</h2>
          <p class="status-line">
            <strong>Signal</strong>:
            <span id="aiStatus">Calculating…</span>
          </p>
          <canvas id="aiChart" aria-label="AI learning chart"></canvas>
          <div class="controls">
            <label for="aiDay">Day
              <input id="aiDay" type="number" min="1" max="30" value="1" />
            </label>
            <label for="aiValue">Videos
              <input id="aiValue" type="number" step="0.1" value="2" />
            </label>
            <button id="aiLog">Log AI</button>
          </div>
          <div class="formula">R' = R + 32 × (S − E)</div>
        </section>
      </div>
      <footer>
        <span>Expected lines: linear velocity Dec 1 → Dec 30</span>
        <span>Data cached locally · refresh safe</span>
      </footer>
    </div>
    <script>
      const DAYS = 30;
      const BASE_ELO = 1500;
      const K = 32;
      const labels = Array.from({ length: DAYS }, (_, i) => `Dec ${i + 1}`);
      const config = {
        health: {
          target: 20,
          color: "#92ff8a",
          defaults: [{ day: 1, value: 1 }],
          unit: "workouts",
        },
        coding: {
          target: 300,
          color: "#8fd3ff",
          defaults: [{ day: 1, value: 5 }],
          unit: "problems",
        },
        ai: {
          target: 30,
          color: "#ffb347",
          defaults: [{ day: 1, value: 2 }],
          unit: "videos",
        },
      };
      const actuals = {};
      const expecteds = {};
      const charts = {};

      const buildExpected = (target) =>
        labels.map((_, idx) =>
          Number(((target / DAYS) * (idx + 1)).toFixed(2))
        );

      const loadActual = (key, defaults) => {
        const storageKey = `velocity-${key}`;
        try {
          const stored = JSON.parse(localStorage.getItem(storageKey));
          if (Array.isArray(stored) && stored.length === DAYS) {
            return stored;
          }
        } catch (err) {
          console.warn("Resetting stored data", err);
        }
        const seeded = Array(DAYS).fill(null);
        defaults.forEach(({ day, value }) => {
          seeded[day - 1] = value;
        });
        localStorage.setItem(storageKey, JSON.stringify(seeded));
        return seeded;
      };

      const persistActual = (key) => {
        localStorage.setItem(
          `velocity-${key}`,
          JSON.stringify(actuals[key])
        );
      };

      const getLastFilledIndex = (data) => {
        for (let i = data.length - 1; i >= 0; i -= 1) {
          if (typeof data[i] === "number") {
            return i;
          }
        }
        return 0;
      };

      const describeStatus = (actual, expected) => {
        const diff = actual - expected;
        if (diff > 0.5) return "over target";
        if (diff < -0.5) return "under target";
        return "on track";
      };

      const computeElo = (actual, expected) => {
        const S = actual >= expected ? 1 : 0;
        const E = 1 / (1 + Math.pow(10, (expected - actual) / 400));
        const rating = Math.round(BASE_ELO + K * (S - E));
        const bracket = rating >= BASE_ELO ? "increase" : "drop";
        return { rating, bracket, S: Number(S.toFixed(2)), E: Number(E.toFixed(2)) };
      };

      const refreshStatus = (key) => {
        const idx = getLastFilledIndex(actuals[key]);
        const actual = actuals[key][idx] ?? 0;
        const expected = expecteds[key][idx] ?? 0;
        const status = describeStatus(actual, expected);
        const elo = computeElo(actual, expected);
        const statusEl = document.getElementById(`${key}Status`);
        statusEl.textContent = `${status} · Elo ${elo.rating} (${elo.bracket})`;
        statusEl.setAttribute(
          "data-detail",
          `S=${elo.S} E=${elo.E}`
        );
      };

      const buildChart = (key) => {
        const chart = new Chart(document.getElementById(`${key}Chart`), {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Expected velocity",
                data: expecteds[key],
                borderColor: "#ffffff",
                borderWidth: 1,
                pointRadius: 0,
                tension: 0,
                fill: false,
                spanGaps: true,
              },
              {
                label: "Actual progress",
                data: actuals[key],
                borderColor: config[key].color,
                borderWidth: 2,
                pointBackgroundColor: config[key].color,
                pointRadius: 3,
                tension: 0.1,
                fill: false,
                spanGaps: true,
              },
            ],
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: "#9d9d9d",
                  boxWidth: 10,
                },
              },
              tooltip: {
                mode: "index",
                intersect: false,
                backgroundColor: "#111",
                borderColor: "#444",
                borderWidth: 1,
                titleColor: "#f7f7f2",
                bodyColor: "#f7f7f2",
              },
            },
            interaction: {
              mode: "nearest",
              axis: "x",
              intersect: false,
            },
            scales: {
              x: {
                ticks: { color: "#646464", maxRotation: 0 },
                grid: { color: "#1c1c1c" },
              },
              y: {
                ticks: { color: "#646464" },
                grid: { color: "#1c1c1c" },
              },
            },
          },
        });
        charts[key] = chart;
      };

      const wireLogging = (key) => {
        const dayInput = document.getElementById(`${key}Day`);
        const valueInput = document.getElementById(`${key}Value`);
        const button = document.getElementById(`${key}Log`);
        button.addEventListener("click", () => {
          const day = Number(dayInput.value);
          const value = Number(valueInput.value);
          if (!day || day < 1 || day > DAYS || Number.isNaN(value)) {
            return;
          }
          actuals[key][day - 1] = value;
          persistActual(key);
          charts[key].update("none");
          refreshStatus(key);
        });
      };

      const init = () => {
        Chart.defaults.font.family = "Space Mono, monospace";
        Object.keys(config).forEach((key) => {
          expecteds[key] = buildExpected(config[key].target);
          actuals[key] = loadActual(key, config[key].defaults);
          buildChart(key);
          wireLogging(key);
          refreshStatus(key);
        });
      };

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
